<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Ad - Earn Money</title>
    
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Monetag SDK - YOUR ZONE ID -->
    <script src='//libtl.com/sdk.js' data-zone='10214030' data-sdk='show_10214030'></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            color: white; padding: 20px;
        }
        .container { text-align: center; max-width: 400px; width: 100%; }
        .logo { font-size: 64px; margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .title { font-size: 28px; font-weight: bold; margin-bottom: 10px; }
        .subtitle { font-size: 16px; opacity: 0.9; margin-bottom: 30px; }
        .spinner { 
            border: 4px solid rgba(255,255,255,0.3); 
            border-top: 4px solid white; 
            border-radius: 50%; 
            width: 60px; height: 60px; 
            animation: spin 1s linear infinite; 
            margin: 30px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status { 
            font-size: 18px; margin-top: 20px; padding: 15px; 
            background: rgba(255,255,255,0.1); border-radius: 12px; 
            backdrop-filter: blur(10px); 
        }
        .success { background: rgba(46,213,115,0.2); border: 2px solid #2ed573; }
        .error { background: rgba(255,71,87,0.2); border: 2px solid #ff4757; }
        .progress { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg,#2ed573,#26de81); width: 0%; transition: width 0.3s ease; }
        .reward-badge { 
            position: absolute; top: 20px; right: 20px; 
            background: #2ed573; color: white; padding: 8px 16px; 
            border-radius: 25px; font-weight: bold; font-size: 14px; 
            box-shadow: 0 4px 15px rgba(46,213,115,0.4);
        }
    </style>
</head>
<body>
    <!-- Reward Badge -->
    <div class="reward-badge">ðŸ’° â‚¹3-5 REWARD</div>
    
    <div class="container">
        <div class="logo">ðŸ“º</div>
        <div class="title" id="title">Loading Premium Ad...</div>
        <div class="subtitle" id="subtitle">Get ready to earn instantly!</div>
        <div class="spinner" id="spinner"></div>
        <div class="status" id="status">Connecting to ad network...</div>
        <div class="progress">
            <div class="progress-bar" id="progress"></div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIG - YOUR VPS ENDPOINT
        // ========================================
        const CONFIG = {
            API_URL: 'https://YOUR_VPS_IP:8000/cashyads/ad-completed',  // UPDATE WITH YOUR VPS IP
            DEBUG: false  // Set true for testing
        };
        
        // Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand(); tg.disableVerticalSwipes();
        
        // User data
        const initData = tg.initDataUnsafe;
        const userId = initData?.user?.id;
        const statusEl = document.getElementById('status');
        const progressEl = document.getElementById('progress');
        const titleEl = document.getElementById('title');
        const subtitleEl = document.getElementById('subtitle');
        const spinnerEl = document.getElementById('spinner');
        
        // ========================================
        // UI HELPERS
        // ========================================
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updateProgress(percent) {
            progressEl.style.width = Math.min(100, percent) + '%';
        }
        
        function showSpinner(show = true) {
            spinnerEl.style.display = show ? 'block' : 'none';
        }
        
        // ========================================
        // BACKEND CALLBACK
        // ========================================
        async function notifyBackend(result) {
            if (!userId) {
                log('âŒ Invalid user session', 'error');
                setTimeout(() => tg.close(), 2000);
                return;
            }
            
            try {
                titleEl.textContent = 'Processing Reward...';
                subtitleEl.textContent = 'Your earnings are being credited!';
                log('ðŸ”„ Verifying ad completion...', 'info');
                updateProgress(85);
                showSpinner(false);
                
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        result: result,
                        timestamp: Date.now(),
                        init_data: tg.initData,
                        user_agent: navigator.userAgent
                    })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                titleEl.textContent = 'âœ… Reward Credited!';
                subtitleEl.textContent = `â‚¹${data.reward || 3} added to balance!`;
                log(`ðŸŽ‰ Earned â‚¹${data.reward || 3}! New balance: â‚¹${data.new_balance || '?'}`, 'success');
                updateProgress(100);
                
                // Success vibration + close
                tg.HapticFeedback.impactOccurred('light');
                setTimeout(() => tg.close(), 3000);
                
            } catch (error) {
                log('âŒ Reward processing failed', 'error');
                console.error('Backend error:', error);
                titleEl.textContent = 'Try Again?';
                setTimeout(() => tg.close(), 4000);
            }
        }
        
        // ========================================
        // MONETAG VIDEO AD
        // ========================================
        async function loadAndPlayAd() {
            try {
                // User validation
                if (!userId) {
                    log('âŒ Authentication failed', 'error');
                    setTimeout(() => tg.close(), 2000);
                    return;
                }
                
                titleEl.textContent = 'ðŸ”„ Loading Premium Ad...';
                subtitleEl.textContent = 'Powered by Monetag Network';
                log('Connecting to ad network...', 'info');
                updateProgress(15);
                
                // Wait for Monetag SDK (max 5s)
                let sdkReady = false;
                for (let i = 0; i < 50; i++) {
                    if (typeof show_10214030 !== 'undefined') {
                        sdkReady = true;
                        break;
                    }
                    await new Promise(r => setTimeout(r, 100));
                }
                
                if (!sdkReady) {
                    throw new Error('Ad network timeout');
                }
                
                titleEl.textContent = 'â–¶ï¸ Watch Full Video';
                subtitleEl.textContent = 'Complete to earn â‚¹3-5';
                log('ðŸŽ¥ Premium rewarded video ready!', 'success');
                updateProgress(50);
                showSpinner(false);
                
                // Play Monetag rewarded ad
                show_10214030().then(() => {
                    // SUCCESS - User watched full ad
                    titleEl.textContent = 'ðŸŽ‰ Ad Completed!';
                    log('âœ… Video watched successfully!', 'success');
                    notifyBackend('completed');
                }).catch((err) => {
                    // User closed/skipped
                    log('âš ï¸ Ad interrupted', 'error');
                    titleEl.textContent = 'Ad incomplete';
                    if (CONFIG.DEBUG) {
                        setTimeout(() => notifyBackend('debug'), 1500);
                    } else {
                        setTimeout(() => tg.close(), 2500);
                    }
                });
                
            } catch (error) {
                log('âŒ Failed to load ad', 'error');
                console.error('Ad error:', error);
                titleEl.textContent = 'Ad temporarily unavailable';
                
                if (CONFIG.DEBUG) {
                    setTimeout(() => notifyBackend('debug'), 2000);
                } else {
                    setTimeout(() => tg.close(), 3500);
                }
            }
        }
        
        // ========================================
        // INITIALIZE
        // ========================================
        log('ðŸš€ CashyAds Premium Ads', 'info');
        updateProgress(5);
        
        // Theme sync
        tg.requestViewport(400, 600);
        
        // Auto-start
        window.addEventListener('load', () => {
            tg.HapticFeedback.impactOccurred('medium');
            setTimeout(loadAndPlayAd, 1200);
        });
    </script>
</body>
</html>
