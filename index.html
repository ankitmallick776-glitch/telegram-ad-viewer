<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CashyAds Video Ads</title>
</head>
<body style="font-family:Arial,sans-serif;max-width:400px;margin:40px auto;padding:20px;text-align:center;">
  <h1>üé¨ Premium Video Ads</h1>
  <p>Watch 25s video ‚Üí Earn ‚Çπ3-5 instantly!</p>
  
  <button id="showAd" style="background:#1a73e8;color:white;border:none;padding:15px 30px;border-radius:8px;font-size:18px;cursor:pointer;">‚ñ∂Ô∏è Watch Video Ad</button>
  <div id="status" style="margin:20px 0;font-weight:bold;"></div>

  <!-- Monetag SDK -->
  <script src="//libtl.com/sdk.js" data-zone="10214030" data-sdk="show_10214030"></script>
  
  <script>
    // ‚úÖ YOUR ACTUAL VPS IP AND PORT (from your .env VPS_IP and API_PORT)
    const API_URL = 'http://103.138.96.188:8001/cashyads/ad-completed'; // ‚Üê CHANGE THIS
    
    function getUserId() {
      // ‚úÖ Priority 1: Telegram WebApp (real user ID)
      if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
        return window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
      }
      // ‚úÖ Priority 2: URL parameter (bot sends ?user_id=123)
      const urlParams = new URLSearchParams(window.location.search);
      const urlUserId = urlParams.get('user_id');
      if (urlUserId) return parseInt(urlUserId);
      // ‚úÖ Fallback for testing
      return 123456789;
    }

    const userId = getUserId();
    console.log('üì± User ID:', userId); // Check browser console

    document.getElementById('showAd').onclick = async () => {
      const statusEl = document.getElementById('status');
      statusEl.textContent = '‚è≥ Loading ad...';
      
      try {
        // ‚úÖ Show Monetag ad
        await show_10214030();
        
        statusEl.textContent = 'üé¨ Calling bot API...';
        
        // ‚úÖ Call your EXACT bot endpoint
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_id: userId,
            result: 'video_completed'  // ‚úÖ Matches your bot's success_results
          })
        });
        
        const data = await response.json();
        console.log('ü§ñ Bot response:', data); // Check console
        
        if (data.success) {
          statusEl.innerHTML = `‚úÖ <b>‚Çπ${data.reward} added!</b><br>Balance: ‚Çπ${data.new_balance}`;
        } else {
          statusEl.innerHTML = `‚ùå ${data.message || 'Failed'}`;
        }
        
      } catch(error) {
        console.error('‚ùå ERROR:', error);
        statusEl.textContent = '‚ùå Network/API error - check console';
      }
    };

    // ‚úÖ Telegram WebApp init
    if (window.Telegram?.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  </script>
</body>
</html>
